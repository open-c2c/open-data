name: Create Conventions Release

on:
  push:
    tags:
      - 'v*'  # Trigger only on version tags (e.g., v1.0.0)

jobs:
  attach-zip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get the Release Tag
        id: get_tag
        run: |
          # Extract the current tag from the environment or input (e.g., workflow_dispatch)
          echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Generate Diff for ./conventions Folder
        run: |
          git fetch --tags
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
          echo "Previous Tag: $PREVIOUS_TAG"
          git diff --name-status $PREVIOUS_TAG HEAD -- ./conventions > changes.txt

      - name: Prepare Added/Modified Files
        run: |
          mkdir -p release
          grep '^[AM]' changes.txt | awk '{print $2}' | xargs -I {} cp --parents {} release/

      - name: Prepare Deleted Files
        run: |
          grep '^D' changes.txt | awk '{print $2}' > release/deleted.json

      - name: Create ZIP File
        run: zip -r release.zip release/

      - name: Get Existing Release Upload URL
        id: get_release
        uses: octokit/request-action@v2
        with:
          route: GET /repos/${{ github.repository }}/releases/tags/${{ env.TAG_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.get_release.outputs.data | fromJSON('upload_url') }}
          asset_path: ./release.zip
          asset_name: release-conventions-${{ env.TAG_NAME }}.zip
          asset_content_type: application/zip
